<!-- Acá vamos a armar el formulario -->
<!-- Nombre completo, Fecha de nacimiento, Experiencia
como actor o modelo, Foto del cuerpo completo, foto de la cara, etnia. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script> <!-- Conecto con supabase -->
</head>
<body>
   <h1>Casting Calls</h1>
   <form id="nuevoForm">
    <!-- Nombre completo -->
    <label for="nombre" >Nombre completo</label>
    <input type="text" id="nombre" placeholder="Escriba aquí">
    <br> <br> <br>
    <!-- Fecha de nacimiento --> 
     <h3>Fecha de nacimiento</h3>
     <!-- Pido condiciones sobre los valores -->
     <label for="dia">Dia</label>
     <input type="number" id="dia" min="1" max="31" required />
     <label for="mes">Mes</label>
     <input type="number" id="mes" min="1" max="12" required /> 
     <label for="anio">Año</label>
     <input type="number" id="anio" min="1900" max="2030    " required />
     <!-- Etnia -->
     <h3>Etnia</h3>
     <select id="etnia">
        <option value="Blanco">Blanco/Caucácico</option>
        <option value="Hispano">Hispano</option>
        <option value="latino">Latinoamericano</option>
        <option value="Afroamericano">Afroamericano</option>
        <option value="O">Otro</option>
     </select>
     <!-- etnia opcional -->
      <div id="EtniaDiv" style="display:none;">
        <br> <br>
        <label for="etniaO">¿Cuál?</label>
        <input type="text" id="etnia0">
      </div>
      <br> <br> <br>
    <!-- Contacto email-->
     <label for="email">Email:</label>
     <input type="email" id="email" placeholder="Escriba aquí"/>
     <!-- Contacto Wpp -->
      <br> <br> <br>
     <label for="tel">Número de WhatsApp o telefono</label>
     <input type="text" id="tel" placeholder="1112345678"/>
     <!-- Experiencia como actor/modelo -->
     <br> <br> <br>
     <h4>Contanos tu experiencia como actor o modelo.</h4>
     <p>Por favor, completa la información correspondiente en el caso de tener
        experiencia.
     </p>
     <label for="TieneExperiencia"></label>
     <select id="TieneExperiencia">
        <option value="No">No, no tengo experiencia</option>
        <option value="Si">Si, tengo experiencia</option>  
      </select>
      <br>
      <div id="campoExp" style="display:none"> <!-- Está predeterminadamente puesto para 
        que el usuario no tiene experiencia -->
        <label for="exp"></label>
        <h4>Contanos un poco de tu experiencia</h4>
        <input type="text" id="exp" />
        <h4>Inserte aquí un link a su contenido/portafolio</h4>
        <label for="portafolio"></label>
        <input type="text" id="portafolio" />
      </div>
     <!-- Pido fotos al usuario -->
      <br> <br> <br>
      <h3>Fotos</h3>
     <label for="fotocara">Primera foto de tu cara (obligatorio)</label>
     <input type="file" id="foto1" accept="image/*" /> 
     <br> <br> <br>
     <label for="fotocara">Segunda foto de tu cara (opcional)</label>
     <input type="file" id="foto2" accept="image/*" /> 
     <br> <br> <br>
     <label for="foto3">Primera foto de cuerpo entero (opcional)</label>
     <input type="file" id="foto3" accept="image/*" />
     <br> <br> <br>
     <label for="foto4">Segunda foto de tu cuerpo entero (opcional)</label>
     <input type="file" id="foto4" accept="image/*" />
     <br> <br> <br>
     <!-- Submit -->
     <br> <br> <br>
     <button type="submit">Enviar</button>
   </form>
   <p id="subiendo" style="display:none;">Enviando formulario, por favor esperá...</p>

   <!-- Código de JS -->
    <script>
/* Display de exigir información: si el usuario tiene experiencia, el 
    el formulario le pide que la ingrese */
    const select_exp = document.getElementById('TieneExperiencia');
    const Campo_exp = document.getElementById('campoExp');
    select_exp.addEventListener('change',function(){
        if (select_exp.value === "Si") {
            Campo_exp.style.display = "block";
        } else {
            Campo_exp.style.display = "none";
        }
    });
    /* Display de exigir etnia */
    const etniaOp = document.getElementById('etnia')
    const container = document.getElementById('EtniaDiv')
    const campoEtnia = document.getElementById('etnia0')
    etniaOp.addEventListener("change",function(){
        if (etniaOp.value==="O") {
            container.style.display ="block";
        } else {
            container.style.display ="none";
        }
    })


/* A la función le voy a agregar la funcionalidad de agregar los datos en una database en Supabase. */ 
        // Para eso pongo los datos necesarios del cliente.
    const supabaseUrl = 'https://xgoebqksbwzwznqtkizq.supabase.co'; /* Proyect URl */
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhnb2VicWtzYnd6d3pucXRraXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1Mzk2MDQsImV4cCI6MjA2NDExNTYwNH0.mvOWtLgH5Y05IRzcEPN6W9c9zfyc1PIcTo5HLLF89Uo';  // 
    const cliente = supabase.createClient(supabaseUrl, supabaseKey);

/* Armamos un objeto de Js para guardar la info */
    document.querySelector('#nuevoForm').addEventListener('submit', async function(e){ //el await del supabase solo se puede usar en funciones async
        e.preventDefault();
        //Abrimos párrafo que dice que arranca a subir las fotos
        document.getElementById("subiendo").style.display = "block";
        console.log('Submit capturado');
        /* Empiezo a recopilar los datos del cliente. */
        datos=["nombre", "dia","mes","anio","etnia","email","tel", "TieneExperiencia", "exp", "portafolio","foto1","foto2","foto3","foto4"];
        obj={nombre:"",
            dia:"",
            mes:"",
            anio:"",
            etnia:"",
            tel:"",
            foto1:null,
            foto2:null,
            foto3:null,
            foto4:null,
            email:"",
            TieneExperiencia:"",
            exp:"",
            portafolio:""
        };

        for (let i=0; i<datos.length;i++){
            let id = datos[i];
            let elemento = document.querySelector(`#${id}`)
            console.log(elemento.textContent)
            /* Para los archivos de foto, usamos .files[0] en vez de .value */
            if (elemento && elemento.type === "file") {
                obj[id] = elemento.files[0] || null;
            } else if (elemento) {
                obj[id]=elemento.value;
            }

        }
            // Ajustar valor si etnia === 'O'
        const etniaOInput = document.getElementById('etnia0');
        if (obj.etnia === 'O') {
          obj.etnia = etniaOInput.value || 'Otro (sin especificar)';
        }
        console.log(obj);


        /* Tengo que transformar la fecha a formato ISO */
        const dia = obj.dia.padStart(2,'0');
        const mes= obj.mes.padStart(2,'0');
        const anio=obj.anio;
        obj.FechaDeNac= `${anio}-${mes}-${dia}`; //Tiene que tener las comillas esas raras si o si. Ese es el formato ISO.
        //Borro los elementos del objeto inecesarios.
        delete obj.dia;
        delete obj.mes;
        delete obj.anio;

        /* Subo los archivos de foto al bucket fotos-casting del supabase y lo enlazo con la info en la
        base de datos */
        // Función auxiliar para subir archivos a Supabase Storage
        async function subirFoto(nombreCampo, archivo) {
            if (!archivo) return null;
            const nombreArchivo = `${Date.now()}-${obj.nombre}-${nombreCampo}.jpg`;
            const carpeta = (nombreCampo.includes("foto1") || nombreCampo.includes("foto2")) ? "caras" : "cuerpo";
            const { data: uploadData, error: uploadError } = await cliente.storage
                .from('fotos-casting')
                .upload(`${carpeta}/${nombreArchivo}`, archivo, {
                contentType: archivo.type,
                });
            if (uploadError) {
                console.error(`Error subiendo ${nombreCampo}:`, uploadError.message);
                return null;
            }

            return `${supabaseUrl}/storage/v1/object/public/fotos-casting/${uploadData.path}`;
            }

        // Subo fotos del objeto al bucket (en un momento las estaba subiendo en serie y tardaba mil años)
        // Subir fotos en paralelo para evitar lags
        const [url1, url2, url3, url4] = await Promise.all([
            subirFoto("foto1", obj.foto1),
            subirFoto("foto2", obj.foto2),
            subirFoto("foto3", obj.foto3),
            subirFoto("foto4", obj.foto4)
        ]);
        obj.foto1 = url1;
        obj.foto2 = url2;
        obj.foto3 = url3;
        obj.foto4 = url4;
        //Listo las fotos
        document.getElementById("subiendo").style.display = "none";
        /* Ya creado el objeto, lo inserto en la tabla de supabase*/
        const { data, error } = await cliente
        .from('Casting Calls')
        .insert([obj]);
        /* Si me tira error */
        if (error) {
        console.error('Error al insertar en Supabase:', error.message);
        } else {
        console.log('Datos guardados correctamente:', data);
        alert("¡Formulario enviado correctamente!");
        document.getElementById("nuevoForm").reset();
        }
    });

</script>
</body>
</html>
